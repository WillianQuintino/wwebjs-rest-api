# ✈️ Deploy no Fly.io - 100% Grátis com Volume

## 🎯 Por que Fly.io?

- ✅ **3GB de volume GRÁTIS** (sessões WhatsApp persistem!)
- ✅ **Região Brasil (GRU)** - menor latência
- ✅ **Não dorme** - sempre online
- ✅ **3 VMs grátis** - 256MB RAM cada
- ✅ **160GB bandwidth/mês**
- ✅ **100% grátis para sempre**

---

## 📋 Pré-requisitos

### 1. Instalar Fly CLI

**Windows (PowerShell como Administrador):**
```powershell
iwr https://fly.io/install.ps1 -useb | iex
```

**Linux/Mac:**
```bash
curl -L https://fly.io/install.sh | sh
```

**Verificar instalação:**
```bash
flyctl version
```

### 2. Criar Conta e Login

```bash
# Criar conta (abre navegador)
flyctl auth signup

# Ou fazer login se já tem conta
flyctl auth login
```

**IMPORTANTE**: Fly.io pede cartão, mas **não cobra nada** no free tier!

---

## 🚀 Deploy (5 Minutos)

### Passo 1: Preparar Aplicação

Você já tem tudo pronto! O arquivo `fly.toml` já está configurado.

### Passo 2: Lançar Aplicação

```bash
# Na raiz do projeto
flyctl launch

# Responda as perguntas:
# ? Choose an app name: whatsapp-api-SEU-NOME
# ? Choose a region: gru (São Paulo)
# ? Would you like to set up a PostgreSQL database? No
# ? Would you like to set up an Upstash Redis database? No
# ? Create .dockerignore from 1 .gitignore files? Yes
# ? Would you like to deploy now? No (vamos configurar primeiro)
```

### Passo 3: Criar Volume para Sessões

```bash
# Criar volume de 1GB em São Paulo
flyctl volumes create whatsapp_data --region gru --size 1

# Confirmar criação
flyctl volumes list
```

### Passo 4: Configurar Secrets (Variáveis Sensíveis)

```bash
# Gerar e configurar API_KEY
flyctl secrets set API_KEY=$(openssl rand -hex 32)

# Configurar ALLOWED_ORIGINS (substitua pelo seu domínio)
flyctl secrets set ALLOWED_ORIGINS="https://whatsapp-api-SEU-NOME.fly.dev"

# Ver secrets configurados
flyctl secrets list
```

### Passo 5: Ajustar Configuração (Opcional)

O arquivo `fly.toml` já está configurado, mas você pode personalizar:

```bash
# Editar fly.toml se necessário
# Mudar region, memory, etc.
```

### Passo 6: Deploy!

```bash
# Fazer o deploy
flyctl deploy

# Acompanhar logs durante deploy
flyctl logs
```

Deploy leva ~5 minutos. Aguarde até ver:
```
✓ Deployment successful
```

### Passo 7: Verificar Deploy

```bash
# Ver status
flyctl status

# Abrir no navegador
flyctl open

# Ver logs em tempo real
flyctl logs
```

### Passo 8: Obter URL

```bash
# Ver informações da app
flyctl info

# Sua URL será algo como:
https://whatsapp-api-SEU-NOME.fly.dev
```

### Passo 9: Testar

```bash
# Testar health check
curl https://whatsapp-api-SEU-NOME.fly.dev/health

# Resposta esperada:
{"status":"ok","timestamp":"..."}
```

---

## 📱 Conectar WhatsApp

### 1. Inicializar Sessão

```bash
curl -X POST https://whatsapp-api-SEU-NOME.fly.dev/api/v1/sessions/minha-sessao/init
```

### 2. Ver QR Code

**Opção 1 - Navegador (mais fácil):**
```
https://whatsapp-api-SEU-NOME.fly.dev/api/v1/sessions/minha-sessao/qr/image
```

**Opção 2 - Swagger UI:**
```
https://whatsapp-api-SEU-NOME.fly.dev/api-docs
```

### 3. Escanear com WhatsApp

1. Abra WhatsApp no celular
2. Menu → Aparelhos conectados
3. Conectar um aparelho
4. Escaneie o QR Code

### 4. Verificar Conexão

```bash
curl https://whatsapp-api-SEU-NOME.fly.dev/api/v1/sessions/minha-sessao

# Deve retornar status: "READY"
```

### 5. Enviar Mensagem de Teste

```bash
curl -X POST https://whatsapp-api-SEU-NOME.fly.dev/api/v1/sessions/minha-sessao/messages/send \
  -H "Content-Type: application/json" \
  -d '{
    "chatId": "5511999999999@c.us",
    "content": "🎉 API no Fly.io funcionando!"
  }'
```

---

## 🔧 Comandos Úteis

### Gerenciamento

```bash
# Ver status
flyctl status

# Ver métricas
flyctl dashboard

# Abrir no navegador
flyctl open

# SSH para dentro do container
flyctl ssh console

# Ver logs em tempo real
flyctl logs

# Restart da aplicação
flyctl apps restart whatsapp-api-SEU-NOME
```

### Volumes

```bash
# Listar volumes
flyctl volumes list

# Ver detalhes do volume
flyctl volumes show whatsapp_data

# Criar snapshot (backup)
flyctl volumes snapshots create whatsapp_data

# Listar snapshots
flyctl volumes snapshots list whatsapp_data
```

### Secrets

```bash
# Adicionar secret
flyctl secrets set CHAVE=valor

# Listar secrets
flyctl secrets list

# Remover secret
flyctl secrets unset CHAVE
```

### Escalar

```bash
# Mudar memória (free = até 512MB)
flyctl scale memory 512

# Ver configuração atual
flyctl scale show
```

---

## 🔄 Atualizações

### Deploy Automático

Sempre que fizer mudanças:

```bash
git add .
git commit -m "suas mudanças"
git push

# Fazer deploy
flyctl deploy
```

### Deploy com Build Limpa

```bash
# Sem cache (mais lento, mas garante build limpa)
flyctl deploy --no-cache
```

---

## 📊 Monitoramento

### Dashboard Web

```bash
# Abrir dashboard
flyctl dashboard

# Ver métricas no navegador
```

### Logs

```bash
# Tempo real
flyctl logs

# Últimas 100 linhas
flyctl logs --limit 100

# Filtrar por texto
flyctl logs | grep "error"
```

### Métricas

```bash
# Ver uso de recursos
flyctl status

# Detalhes da VM
flyctl vm status
```

---

## 💾 Backup de Sessões

### Automático (Snapshots)

```bash
# Criar snapshot manual
flyctl volumes snapshots create whatsapp_data

# Listar snapshots
flyctl volumes snapshots list whatsapp_data

# Restaurar de snapshot
# (criar novo volume a partir do snapshot)
flyctl volumes create whatsapp_data_restore --snapshot-id snap_xxx
```

### Manual (Download)

```bash
# SSH para dentro do container
flyctl ssh console

# Dentro do container:
cd /app/sessions
tar -czf /tmp/backup.tar.gz .
cat /tmp/backup.tar.gz | base64

# Copiar output e salvar localmente
# Decodificar com:
base64 -d backup.txt > backup.tar.gz
```

---

## 🐛 Troubleshooting

### Deploy Falhou

```bash
# Ver logs de build
flyctl logs

# Tentar rebuild sem cache
flyctl deploy --no-cache

# Verificar configuração
flyctl config show
```

### App não Responde

```bash
# Verificar status
flyctl status

# Ver health checks
flyctl checks list

# Restart
flyctl apps restart
```

### Volume não Montou

```bash
# Verificar volumes
flyctl volumes list

# Ver logs do container
flyctl logs | grep mount

# Recriar volume se necessário
flyctl volumes destroy whatsapp_data
flyctl volumes create whatsapp_data --region gru --size 1
flyctl deploy
```

### Chromium não Funciona

```bash
# SSH para dentro do container
flyctl ssh console

# Verificar Chromium
which chromium-browser
chromium-browser --version

# Ver logs do Puppeteer
flyctl logs | grep -i chromium
```

### WhatsApp Desconectou

```bash
# Normal após restarts
# Solução: Gerar novo QR

# 1. Destruir sessão antiga
curl -X DELETE https://sua-app.fly.dev/api/v1/sessions/minha-sessao

# 2. Criar nova
curl -X POST https://sua-app.fly.dev/api/v1/sessions/minha-sessao/init

# 3. Escanear novo QR
```

### Ficou sem Recursos Grátis

```bash
# Ver uso atual
flyctl dashboard

# Free tier:
# - 3 VMs compartilhadas (256MB cada)
# - 3GB volumes
# - 160GB bandwidth

# Se excedeu, upgrade ou otimizar:
flyctl scale memory 256  # Reduzir RAM
```

---

## 💰 Custos (Free Tier)

### Incluído Grátis

- ✅ 3 VMs compartilhadas (256-512MB RAM)
- ✅ 3GB de volumes persistentes
- ✅ 160GB bandwidth/mês
- ✅ SSL/TLS certificados
- ✅ Health checks
- ✅ Logs

### O que Gastaria Créditos

- Usar > 3 VMs
- Usar > 3GB volumes
- Usar > 160GB bandwidth
- VMs dedicadas

**Para esta API:** Fica dentro do free tier! 💚

---

## ⚙️ Configurações Avançadas

### Múltiplas Regiões

```bash
# Adicionar região
flyctl regions add iad  # Virginia, USA

# Listar regiões
flyctl regions list

# Remover região
flyctl regions remove iad
```

### Custom Domain

```bash
# Adicionar domínio próprio
flyctl certs add seudominio.com

# Verificar certificado
flyctl certs show seudominio.com

# No seu DNS, adicionar:
# A record: @    -> [IP do fly]
# AAAA record: @ -> [IPv6 do fly]
```

### Variáveis de Ambiente

```bash
# Adicionar via fly.toml [env]
# OU via secrets (dados sensíveis):
flyctl secrets set NOVA_VAR=valor

# Listar todas
flyctl secrets list
```

---

## 🎯 Checklist Final

- [ ] Fly CLI instalado
- [ ] Conta criada e logada
- [ ] App lançada (flyctl launch)
- [ ] Volume criado (1GB em GRU)
- [ ] Secrets configurados (API_KEY)
- [ ] Deploy completado
- [ ] Health check respondendo
- [ ] QR Code gerado
- [ ] WhatsApp conectado
- [ ] Primeira mensagem enviada
- [ ] Logs sem erros
- [ ] Backup feito

---

## 📞 Suporte

- **Documentação**: https://fly.io/docs
- **Community**: https://community.fly.io
- **Status**: https://status.fly.io
- **Discord**: https://fly.io/discord

---

## 🏆 Vantagens do Fly.io

✅ **Região Brasil** - latência baixa
✅ **Volume grátis** - sessões persistem
✅ **Não dorme** - sempre online
✅ **CLI poderosa** - controle total
✅ **IPv6** - futuro-proof
✅ **Snapshots** - backup fácil
✅ **SSH** - debug direto no container

---

**Pronto! Sua API WhatsApp está no ar no Fly.io, 100% grátis, sempre online, com dados persistentes! 🎉**

**Custo: $0/mês**
**Região: São Paulo, Brasil**
**Uptime: 99.9%+**
