# âœˆï¸ Deploy no Fly.io - 100% GrÃ¡tis com Volume

## ğŸ¯ Por que Fly.io?

- âœ… **3GB de volume GRÃTIS** (sessÃµes WhatsApp persistem!)
- âœ… **RegiÃ£o Brasil (GRU)** - menor latÃªncia
- âœ… **NÃ£o dorme** - sempre online
- âœ… **3 VMs grÃ¡tis** - 256MB RAM cada
- âœ… **160GB bandwidth/mÃªs**
- âœ… **100% grÃ¡tis para sempre**

---

## ğŸ“‹ PrÃ©-requisitos

### 1. Instalar Fly CLI

**Windows (PowerShell como Administrador):**
```powershell
iwr https://fly.io/install.ps1 -useb | iex
```

**Linux/Mac:**
```bash
curl -L https://fly.io/install.sh | sh
```

**Verificar instalaÃ§Ã£o:**
```bash
flyctl version
```

### 2. Criar Conta e Login

```bash
# Criar conta (abre navegador)
flyctl auth signup

# Ou fazer login se jÃ¡ tem conta
flyctl auth login
```

**IMPORTANTE**: Fly.io pede cartÃ£o, mas **nÃ£o cobra nada** no free tier!

---

## ğŸš€ Deploy (5 Minutos)

### Passo 1: Preparar AplicaÃ§Ã£o

VocÃª jÃ¡ tem tudo pronto! O arquivo `fly.toml` jÃ¡ estÃ¡ configurado.

### Passo 2: LanÃ§ar AplicaÃ§Ã£o

```bash
# Na raiz do projeto
flyctl launch

# Responda as perguntas:
# ? Choose an app name: whatsapp-api-SEU-NOME
# ? Choose a region: gru (SÃ£o Paulo)
# ? Would you like to set up a PostgreSQL database? No
# ? Would you like to set up an Upstash Redis database? No
# ? Create .dockerignore from 1 .gitignore files? Yes
# ? Would you like to deploy now? No (vamos configurar primeiro)
```

### Passo 3: Criar Volume para SessÃµes

```bash
# Criar volume de 1GB em SÃ£o Paulo
flyctl volumes create whatsapp_data --region gru --size 1

# Confirmar criaÃ§Ã£o
flyctl volumes list
```

### Passo 4: Configurar Secrets (VariÃ¡veis SensÃ­veis)

```bash
# Gerar e configurar API_KEY
flyctl secrets set API_KEY=$(openssl rand -hex 32)

# Configurar ALLOWED_ORIGINS (substitua pelo seu domÃ­nio)
flyctl secrets set ALLOWED_ORIGINS="https://whatsapp-api-SEU-NOME.fly.dev"

# Ver secrets configurados
flyctl secrets list
```

### Passo 5: Ajustar ConfiguraÃ§Ã£o (Opcional)

O arquivo `fly.toml` jÃ¡ estÃ¡ configurado, mas vocÃª pode personalizar:

```bash
# Editar fly.toml se necessÃ¡rio
# Mudar region, memory, etc.
```

### Passo 6: Deploy!

```bash
# Fazer o deploy
flyctl deploy

# Acompanhar logs durante deploy
flyctl logs
```

Deploy leva ~5 minutos. Aguarde atÃ© ver:
```
âœ“ Deployment successful
```

### Passo 7: Verificar Deploy

```bash
# Ver status
flyctl status

# Abrir no navegador
flyctl open

# Ver logs em tempo real
flyctl logs
```

### Passo 8: Obter URL

```bash
# Ver informaÃ§Ãµes da app
flyctl info

# Sua URL serÃ¡ algo como:
https://whatsapp-api-SEU-NOME.fly.dev
```

### Passo 9: Testar

```bash
# Testar health check
curl https://whatsapp-api-SEU-NOME.fly.dev/health

# Resposta esperada:
{"status":"ok","timestamp":"..."}
```

---

## ğŸ“± Conectar WhatsApp

### 1. Inicializar SessÃ£o

```bash
curl -X POST https://whatsapp-api-SEU-NOME.fly.dev/api/v1/sessions/minha-sessao/init
```

### 2. Ver QR Code

**OpÃ§Ã£o 1 - Navegador (mais fÃ¡cil):**
```
https://whatsapp-api-SEU-NOME.fly.dev/api/v1/sessions/minha-sessao/qr/image
```

**OpÃ§Ã£o 2 - Swagger UI:**
```
https://whatsapp-api-SEU-NOME.fly.dev/api-docs
```

### 3. Escanear com WhatsApp

1. Abra WhatsApp no celular
2. Menu â†’ Aparelhos conectados
3. Conectar um aparelho
4. Escaneie o QR Code

### 4. Verificar ConexÃ£o

```bash
curl https://whatsapp-api-SEU-NOME.fly.dev/api/v1/sessions/minha-sessao

# Deve retornar status: "READY"
```

### 5. Enviar Mensagem de Teste

```bash
curl -X POST https://whatsapp-api-SEU-NOME.fly.dev/api/v1/sessions/minha-sessao/messages/send \
  -H "Content-Type: application/json" \
  -d '{
    "chatId": "5511999999999@c.us",
    "content": "ğŸ‰ API no Fly.io funcionando!"
  }'
```

---

## ğŸ”§ Comandos Ãšteis

### Gerenciamento

```bash
# Ver status
flyctl status

# Ver mÃ©tricas
flyctl dashboard

# Abrir no navegador
flyctl open

# SSH para dentro do container
flyctl ssh console

# Ver logs em tempo real
flyctl logs

# Restart da aplicaÃ§Ã£o
flyctl apps restart whatsapp-api-SEU-NOME
```

### Volumes

```bash
# Listar volumes
flyctl volumes list

# Ver detalhes do volume
flyctl volumes show whatsapp_data

# Criar snapshot (backup)
flyctl volumes snapshots create whatsapp_data

# Listar snapshots
flyctl volumes snapshots list whatsapp_data
```

### Secrets

```bash
# Adicionar secret
flyctl secrets set CHAVE=valor

# Listar secrets
flyctl secrets list

# Remover secret
flyctl secrets unset CHAVE
```

### Escalar

```bash
# Mudar memÃ³ria (free = atÃ© 512MB)
flyctl scale memory 512

# Ver configuraÃ§Ã£o atual
flyctl scale show
```

---

## ğŸ”„ AtualizaÃ§Ãµes

### Deploy AutomÃ¡tico

Sempre que fizer mudanÃ§as:

```bash
git add .
git commit -m "suas mudanÃ§as"
git push

# Fazer deploy
flyctl deploy
```

### Deploy com Build Limpa

```bash
# Sem cache (mais lento, mas garante build limpa)
flyctl deploy --no-cache
```

---

## ğŸ“Š Monitoramento

### Dashboard Web

```bash
# Abrir dashboard
flyctl dashboard

# Ver mÃ©tricas no navegador
```

### Logs

```bash
# Tempo real
flyctl logs

# Ãšltimas 100 linhas
flyctl logs --limit 100

# Filtrar por texto
flyctl logs | grep "error"
```

### MÃ©tricas

```bash
# Ver uso de recursos
flyctl status

# Detalhes da VM
flyctl vm status
```

---

## ğŸ’¾ Backup de SessÃµes

### AutomÃ¡tico (Snapshots)

```bash
# Criar snapshot manual
flyctl volumes snapshots create whatsapp_data

# Listar snapshots
flyctl volumes snapshots list whatsapp_data

# Restaurar de snapshot
# (criar novo volume a partir do snapshot)
flyctl volumes create whatsapp_data_restore --snapshot-id snap_xxx
```

### Manual (Download)

```bash
# SSH para dentro do container
flyctl ssh console

# Dentro do container:
cd /app/sessions
tar -czf /tmp/backup.tar.gz .
cat /tmp/backup.tar.gz | base64

# Copiar output e salvar localmente
# Decodificar com:
base64 -d backup.txt > backup.tar.gz
```

---

## ğŸ› Troubleshooting

### Deploy Falhou

```bash
# Ver logs de build
flyctl logs

# Tentar rebuild sem cache
flyctl deploy --no-cache

# Verificar configuraÃ§Ã£o
flyctl config show
```

### App nÃ£o Responde

```bash
# Verificar status
flyctl status

# Ver health checks
flyctl checks list

# Restart
flyctl apps restart
```

### Volume nÃ£o Montou

```bash
# Verificar volumes
flyctl volumes list

# Ver logs do container
flyctl logs | grep mount

# Recriar volume se necessÃ¡rio
flyctl volumes destroy whatsapp_data
flyctl volumes create whatsapp_data --region gru --size 1
flyctl deploy
```

### Chromium nÃ£o Funciona

```bash
# SSH para dentro do container
flyctl ssh console

# Verificar Chromium
which chromium-browser
chromium-browser --version

# Ver logs do Puppeteer
flyctl logs | grep -i chromium
```

### WhatsApp Desconectou

```bash
# Normal apÃ³s restarts
# SoluÃ§Ã£o: Gerar novo QR

# 1. Destruir sessÃ£o antiga
curl -X DELETE https://sua-app.fly.dev/api/v1/sessions/minha-sessao

# 2. Criar nova
curl -X POST https://sua-app.fly.dev/api/v1/sessions/minha-sessao/init

# 3. Escanear novo QR
```

### Ficou sem Recursos GrÃ¡tis

```bash
# Ver uso atual
flyctl dashboard

# Free tier:
# - 3 VMs compartilhadas (256MB cada)
# - 3GB volumes
# - 160GB bandwidth

# Se excedeu, upgrade ou otimizar:
flyctl scale memory 256  # Reduzir RAM
```

---

## ğŸ’° Custos (Free Tier)

### IncluÃ­do GrÃ¡tis

- âœ… 3 VMs compartilhadas (256-512MB RAM)
- âœ… 3GB de volumes persistentes
- âœ… 160GB bandwidth/mÃªs
- âœ… SSL/TLS certificados
- âœ… Health checks
- âœ… Logs

### O que Gastaria CrÃ©ditos

- Usar > 3 VMs
- Usar > 3GB volumes
- Usar > 160GB bandwidth
- VMs dedicadas

**Para esta API:** Fica dentro do free tier! ğŸ’š

---

## âš™ï¸ ConfiguraÃ§Ãµes AvanÃ§adas

### MÃºltiplas RegiÃµes

```bash
# Adicionar regiÃ£o
flyctl regions add iad  # Virginia, USA

# Listar regiÃµes
flyctl regions list

# Remover regiÃ£o
flyctl regions remove iad
```

### Custom Domain

```bash
# Adicionar domÃ­nio prÃ³prio
flyctl certs add seudominio.com

# Verificar certificado
flyctl certs show seudominio.com

# No seu DNS, adicionar:
# A record: @    -> [IP do fly]
# AAAA record: @ -> [IPv6 do fly]
```

### VariÃ¡veis de Ambiente

```bash
# Adicionar via fly.toml [env]
# OU via secrets (dados sensÃ­veis):
flyctl secrets set NOVA_VAR=valor

# Listar todas
flyctl secrets list
```

---

## ğŸ¯ Checklist Final

- [ ] Fly CLI instalado
- [ ] Conta criada e logada
- [ ] App lanÃ§ada (flyctl launch)
- [ ] Volume criado (1GB em GRU)
- [ ] Secrets configurados (API_KEY)
- [ ] Deploy completado
- [ ] Health check respondendo
- [ ] QR Code gerado
- [ ] WhatsApp conectado
- [ ] Primeira mensagem enviada
- [ ] Logs sem erros
- [ ] Backup feito

---

## ğŸ“ Suporte

- **DocumentaÃ§Ã£o**: https://fly.io/docs
- **Community**: https://community.fly.io
- **Status**: https://status.fly.io
- **Discord**: https://fly.io/discord

---

## ğŸ† Vantagens do Fly.io

âœ… **RegiÃ£o Brasil** - latÃªncia baixa
âœ… **Volume grÃ¡tis** - sessÃµes persistem
âœ… **NÃ£o dorme** - sempre online
âœ… **CLI poderosa** - controle total
âœ… **IPv6** - futuro-proof
âœ… **Snapshots** - backup fÃ¡cil
âœ… **SSH** - debug direto no container

---

**Pronto! Sua API WhatsApp estÃ¡ no ar no Fly.io, 100% grÃ¡tis, sempre online, com dados persistentes! ğŸ‰**

**Custo: $0/mÃªs**
**RegiÃ£o: SÃ£o Paulo, Brasil**
**Uptime: 99.9%+**
